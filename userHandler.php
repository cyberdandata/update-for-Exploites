<?php
header('Content-Type: application/json');

// Path to store user data (you could also use a database)
$dataFile = 'users.json';

// Handle actions
$action = $_GET['action'] ?? '';

if ($action === 'submit') {
    // Get user data from the public site
    $input = json_decode(file_get_contents('php://input'), true);

    // Validate input
    if (!isset($input['name'], $input['surname'], $input['address'], $input['mobile'], $input['email'])) {
        echo json_encode(['success' => false, 'message' => 'Invalid input data']);
        exit;
    }

    // Read existing data
    $users = file_exists($dataFile) ? json_decode(file_get_contents($dataFile), true) : [];

    // Add new user with unique ID
    $newUser = array_merge($input, ['id' => uniqid()]);
    $users[] = $newUser;

    // Save updated data to file
    file_put_contents($dataFile, json_encode($users));

    echo json_encode(['success' => true, 'message' => 'User data submitted successfully']);
} elseif ($action === 'fetch') {
    // Fetch all user data (for the admin page)
    if (file_exists($dataFile)) {
        $users = json_decode(file_get_contents($dataFile), true);
        echo json_encode(['success' => true, 'users' => $users]);
    } else {
        echo json_encode(['success' => false, 'message' => 'No data found']);
    }
} elseif ($action === 'delete') {
    // Delete a user by ID (for admin page)
    $input = json_decode(file_get_contents('php://input'), true);
    $userId = $input['id'] ?? '';

    // Debugging: Check if the userId is being sent properly
    error_log('Deleting user with ID: ' . $userId);  // Log to PHP error log

    if (!$userId) {
        echo json_encode(['success' => false, 'message' => 'Invalid user ID']);
        exit;
    }

    // Read existing data
    if (file_exists($dataFile)) {
        $users = json_decode(file_get_contents($dataFile), true);
        
        // Filter out the user by ID
        $users = array_filter($users, function ($user) use ($userId) {
            return $user['id'] !== $userId;
        });

        // Reindex the array after filtering
        $users = array_values($users);

        // Save updated data back to the file
        file_put_contents($dataFile, json_encode($users));

        echo json_encode(['success' => true, 'message' => 'User deleted successfully']);
    } else {
        echo json_encode(['success' => false, 'message' => 'No data found']);
    }
} else {
    echo json_encode(['success' => false, 'message' => 'Invalid action']);
}
?>
